#' @title Spatial Warnings Indicators
#'
#' @description This functions computes all the indicators of critical 
#'   transitions in a convenient form. 
#' 
#' @references KÃ©fi, S., Guttal, V., Brock, W. A., Carpenter, S. R., Ellison, 
#' A. M., Livina, V. N., ... & Dakos, V. (2014). Early warning signals of 
#' ecological transitions: methods for spatial patterns. PloS one, 9(3), e92097.
#'        
#' @param mat A binary matrix or a list of square binary matrices
#' 
#'@export
spatialwarnings <- 
  function(mat,
           indicators = list(variance = spatialwarnings::indicator_variance,
                             skewness = spatialwarnings::indicator_skewness,
                             moran    = spatialwarnings::indicator_moran,
                             psdfit   = spatialwarnings::indicator_fitpsd,
                             largestpatch = spatialwarnings::indicator_largestpatch,
                             fracgeo  = spatialwarnings::indicator_fracgeo,
                             cumpsd   = spatialwarnings::indicator_cumpsd),
           args = list(), 
           verbose = FALSE, 
           ...) { # passed to conversion of the mat object
  
  # Not included yet: indicator_corrfunc, indicator_powerspectrum
  
  # Try to convert the input object to binary matrix format 
  mat <- as.binary_matrix(mat, ...)
  
  if ( inherits(mat, 'list')) {
    result <- lapply(mat, spatialwarnings, indicators, args, verbose)
    result <- list(call = match.call(), 
                   result = result, 
                   indicator_names = names(indicators))
    
    class(result) <- c('spatialwarnings', 'list')
    attr(result, 'is_replicated') <- TRUE
    return(result)
  }
  
  # Compute indicators
  indic_results <- list()
  for ( i in seq.int(length(indicators)) ) { 
    
    if (verbose) message('Computing ', names(indicators)[i], "...")
    
    if (names(indicators)[i] %in% names(args)) { 
      # /!\ args[[i]] here should be a LIST ! (even one of one element)
      indic_results[[i]] <- do.call(indicators[[i]], c(mat, args[[i]]))
    } else { 
      indic_results[[i]] <- do.call(indicators[[i]], list(mat))
    }
  }
  names(indic_results) <- names(indicators)
  
  # Format and output results
  result <- list(call = match.call(),
                 indicators = indic_results)
  class(result) <- c('spatialwarnings','list')
  
  return(result)
}

